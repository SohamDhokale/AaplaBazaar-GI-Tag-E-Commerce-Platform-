{% extends "base.html" %}

{% block title %}Checkout - AaplaBazaar{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <h1 class="section-title">Checkout</h1>
        
        <div class="checkout-container">
            <div class="checkout-form">
                <h3 class="mb-4">Shipping Details</h3>
                
                <form method="post" action="{{ url_for('checkout') }}" id="checkout-form">
                    {{ form.hidden_tag() }}
                    
                    {% if current_user.address %}
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="use-profile-address" 
                               data-address="{{ current_user.address }}"
                               data-city="{{ current_user.city }}"
                               data-state="{{ current_user.state }}"
                               data-pincode="{{ current_user.pincode }}">
                        <label class="form-check-label" for="use-profile-address">
                            Use my profile address
                        </label>
                    </div>
                    {% endif %}
                    
                    <div class="form-group mb-3">
                        {{ form.shipping_address.label(class="form-label") }}
                        {{ form.shipping_address(class="form-control" + (" is-invalid" if form.shipping_address.errors else ""), placeholder="Enter your complete shipping address", rows=3) }}
                        {% for error in form.shipping_address.errors %}
                        <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                {{ form.shipping_city.label(class="form-label") }}
                                {{ form.shipping_city(class="form-control" + (" is-invalid" if form.shipping_city.errors else ""), placeholder="City") }}
                                {% for error in form.shipping_city.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                {{ form.shipping_state.label(class="form-label") }}
                                {{ form.shipping_state(class="form-control" + (" is-invalid" if form.shipping_state.errors else ""), placeholder="State") }}
                                {% for error in form.shipping_state.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                {{ form.shipping_pincode.label(class="form-label") }}
                                {{ form.shipping_pincode(class="form-control" + (" is-invalid" if form.shipping_pincode.errors else ""), placeholder="PIN Code") }}
                                {% for error in form.shipping_pincode.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="mt-4 mb-3">Delivery Options</h3>
                    
                    <div class="form-group mb-4">
                        {{ form.scheduled_date.label(class="form-label") }}
                        {{ form.scheduled_date(class="form-control datepicker", type="date") }}
                        <small class="text-muted">Select a date if you want to schedule this delivery</small>
                    </div>

                    <div class="form-group mb-4">
                        {{ form.schedule_note.label(class="form-label") }}
                        {{ form.schedule_note(class="form-control", placeholder="e.g. Birthday, Anniversary") }}
                    </div>

                    <h3 class="mt-4 mb-3">Gift Options</h3>
                    
                    <div class="form-check mb-3">
                        {{ form.is_gift(class="form-check-input") }}
                        {{ form.is_gift.label(class="form-check-label") }}
                    </div>

                    <div id="giftOptions" style="display: none;">
                        <div class="form-group mb-3">
                            {{ form.gift_wrap_type.label(class="form-label") }}
                            {{ form.gift_wrap_type(class="form-select") }}
                        </div>

                        <div class="form-group mb-4">
                            {{ form.gift_message.label(class="form-label") }}
                            {{ form.gift_message(class="form-control", rows=3, placeholder="Enter your gift message here") }}
                        </div>
                    </div>

                    <h3 class="mt-4 mb-3">Payment Method</h3>
                    
                    <div class="form-group mb-4">
                        {{ form.payment_method.label(class="form-label") }}
                        {{ form.payment_method(class="form-select" + (" is-invalid" if form.payment_method.errors else "")) }}
                        {% for error in form.payment_method.errors %}
                        <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div id="cod-info" class="payment-info bg-light p-3 rounded mb-4">
                        <div class="d-flex align-items-start">
                            <div class="payment-icon cod me-3">
                                <i class="fas fa-truck"></i>
                            </div>
                            <div>
                                <h5 class="mb-2">Cash on Delivery</h5>
                                <p class="mb-1">Pay at your doorstep with verified delivery partners.</p>
                                <p class="text-muted small mb-0">We’ll share SMS updates with your registered number.</p>
                            </div>
                        </div>
                    </div>

                    <div id="upi-section" class="payment-info bg-light p-3 rounded mb-4 d-none">
                        <div class="d-flex align-items-start">
                            <div class="payment-icon upi me-3">
                                <i class="fas fa-qrcode"></i>
                            </div>
                            <div class="w-100">
                                <h5 class="mb-2">Pay via UPI</h5>
                                <p class="mb-3">Scan the QR or tap your preferred UPI app to complete payment.</p>
                                <div class="row g-3">
                                    <div class="col-md-7">
                                        {{ form.upi_reference.label(class="form-label") }}
                                        {{ form.upi_reference(class="form-control" + (" is-invalid" if form.upi_reference.errors else ""), placeholder="name@bank or scan to auto-fill") }}
                                        {% for error in form.upi_reference.errors %}
                                        <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                    <div class="col-md-5 d-grid">
                                        <button type="button" id="start-upi-scan" class="btn btn-secondary">
                                            <i class="fas fa-camera me-2"></i>Scan UPI QR
                                        </button>
                                    </div>
                                </div>
                                <div class="upi-apps mt-3">
                                    <button type="button" class="upi-app-btn gpay" data-upi-app="gpay"><i class="fab fa-google-pay me-2"></i>Google Pay</button>
                                    <button type="button" class="upi-app-btn phonepe" data-upi-app="phonepe"><i class="fas fa-mobile-alt me-2"></i>PhonePe</button>
                                    <button type="button" class="upi-app-btn paytm" data-upi-app="paytm"><i class="fas fa-wallet me-2"></i>Paytm</button>
                                </div>
                                <div class="upi-qr mt-3">
                                    <img id="upi-qr-image" alt="Scan to pay via UPI" class="img-fluid rounded border" 
                                         data-upi-vpa="{{ upi_vpa }}" data-upi-payee="{{ upi_payee }}" data-base-amount="{{ total }}">
                                    <div class="qr-hint text-muted small mt-2">Scan with any UPI app. Amount auto-fills; you can edit before paying.</div>
                                </div>
                                <div id="qr-reader" class="qr-reader mt-3 d-none"></div>
                                <div id="qr-result" class="qr-result text-muted small mt-2"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        {{ form.submit(class="btn btn-primary btn-lg") }}
                    </div>
                </form>
            </div>
            
            <div class="checkout-summary">
                <h3 class="mb-4">Order Summary</h3>
                
                <div class="checkout-items">
                    {% for item in cart_items %}
                    <div class="checkout-item">
                        <div>
                            <strong>{{ item.quantity }}x</strong> {{ item.product.name }}
                        </div>
                        <div>₹{{ item.product.price * item.quantity }}</div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="checkout-total">
                    <span>Total:</span>
                    <span data-base-total="{{ total }}">₹{{ total }}</span>
                </div>
            </div>
        </div>
    </div>
</section>

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode@2.3.9/minified/html5-qrcode.min.js"></script>
<script src="{{ url_for('static', filename='js/payment.js') }}"></script>
<script src="{{ url_for('static', filename='js/checkout.js') }}"></script>
{% endblock %}
{% endblock %}
